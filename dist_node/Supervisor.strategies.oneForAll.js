'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i['return'])_i['return']()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError('Invalid attempt to destructure non-iterable instance')}}}();var _Kernel=require('./Kernel');var _Process=require('./Process');var Process=_interopRequireWildcard(_Process);var _Supervisor=require('./Supervisor.runners');function _interopRequireWildcard(obj){if(obj&&obj.__esModule){return obj}else{var newObj={};if(obj!=null){for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))newObj[key]=obj[key]}}newObj.default=obj;return newObj}}function _toArray(arr){return Array.isArray(arr)?arr:Array.from(arr)}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}exports.default=(()=>{var _ref=_asyncToGenerator(function*(childrenFormulas,name){let childrenRunning;var _spawn=(0,_Kernel.spawn)((()=>{var _ref2=_asyncToGenerator(function*(receive,sv){while(true){var _ref3=yield receive();var _ref4=_toArray(_ref3);const event=_ref4[0];const eventArgs=_ref4.slice(1);switch(event){case'normal':case'shutdown':case'error':{for(let i=0;i<childrenRunning.length;i++){if(childrenRunning[i]){yield Process.demonitor(childrenRunning[i],sv);yield Process.exit(childrenRunning[i],event);var _ref5=yield(0,_Supervisor.runFormula)(childrenFormulas[i]);var _ref6=_slicedToArray(_ref5,2);const fOk=_ref6[0];const fNewPid=_ref6[1];if(!fOk){(0,_Kernel.send)(sv,['error',childrenRunning[i]])}else{childrenRunning[i]=fNewPid;Process.monitor(fNewPid,sv)}}}break}case'supervisor_normal':{var _eventArgs=_slicedToArray(eventArgs,1);const ack=_eventArgs[0];(0,_Supervisor.exitGracefully)(sv,childrenRunning).then(ack);return}case'supervisor_error':{var _eventArgs2=_slicedToArray(eventArgs,1);const ack=_eventArgs2[0];(0,_Supervisor.exitGracefully)(sv,childrenRunning).then(ack);throw new Error('Supervisor ending process')}}}});return function(_x3,_x4){return _ref2.apply(this,arguments)}})(),name);var _spawn2=_slicedToArray(_spawn,2);const ok=_spawn2[0];const sv=_spawn2[1];if(!ok){return[ok,sv]}childrenRunning=yield(0,_Supervisor.startLinkAll)(childrenFormulas,sv);return[ok,sv]});function oneForAll(_x,_x2){return _ref.apply(this,arguments)}return oneForAll})();